# -*- coding: utf-8 -*-
"""GEE_0083_sen2_cdom.ipynb

Tutorial Code by Amirhossein Ahrari
YouTube: https://www.youtube.com/@amirhosseinahrarigee
Tutorial Video: Google Earth Engine Tutorial-165:  Sentinel-2 Colored Dissolved Organic Matter for Water Bodies

This code is part of a tutorial series on Earth Engine programming techniques
presented on the Amirhossein Ahrari YouTube channel. You are free to use and modify
this code for academic and non-academic purposes. Don't forget to subscribe to
the Amirhossein Ahrari channel and follow the videos to support the instructor


"""

import ee

ee.Authenticate()
ee.Initialize(
    project = 'ee-amirhosseinahrari',
    opt_url = 'https://earthengine-highvolume.googleapis.com'
)

import geemap

map = geemap.Map(basemap = 'SATELLITE')
map

roi = map.draw_last_feature.geometry()
roi

def index(img):
  cloud_band = img.select('probability')
  clear_pixel = cloud_band.lt(20)
  ms_bands = img.select('B.*').multiply(0.0001)
  ndwi = ms_bands.normalizedDifference(['B3', 'B8']).rename('ndwi')
  water_body = ndwi.gt(0.1)
  cdom = ms_bands.expression(
      '537 * exp(-2.93 * (B03/B04))',{
          'B03': ms_bands.select('B3'),
          'B04': ms_bands.select('B4')
      }
  ).rename('cdom')
  return cdom.updateMask(clear_pixel).updateMask(water_body).copyProperties(img, ['system:time_start'])



sen2 = (
    ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
    .linkCollection(
        ee.ImageCollection("COPERNICUS/S2_CLOUD_PROBABILITY"), 'probability'
    )
    .filterDate('2024','2025')
    .filterBounds(roi)
    .map(index)

)


sen2

!pip install --upgrade xee

import xarray as xr

ds = xr.open_dataset(
    sen2,
    engine ='ee',
    crs = 'EPSG:4326',
    scale = 0.001,
    geometry = roi
)

ds

ds = ds.sortby('time') * 1

ds_monthly = ds.resample(time = 'M').median('time')

import matplotlib.pyplot as plt

ds_monthly.cdom.plot(
    x = 'lon',
    y = 'lat',
    col = 'time',
    col_wrap = 6,
    robust = True,
    cmap = 'turbo'
)

plt.savefig('cdom.png', dpi = 360, bbox_inches = 'tight')
