# -*- coding: utf-8 -*-
"""GEE_0101_xarray_clip.ipynb

Tutorial Code by Amirhossein Ahrari
YouTube: https://www.youtube.com/@amirhosseinahrarigee
Tutorial Video: Google Earth Engine Tutorial-183: Image Clipping

This code is part of a tutorial series on Earth Engine programming techniques
presented on the Amirhossein Ahrari YouTube channel. You are free to use and modify
this code for academic and non-academic purposes. Don't forget to subscribe to
the Amirhossein Ahrari channel and follow the videos to support the instructor


"""

!pip install --upgrade xee
!pip install -U geemap

import ee

ee.Authenticate()
ee.Initialize(
    project = 'ee-amirhosseinahrari',
    opt_url = 'https://earthengine-highvolume.googleapis.com'
)

import geemap

map = geemap.Map()
map

point = map.draw_last_feature.geometry()
point

border =(
    ee.FeatureCollection("USDOS/LSIB_SIMPLE/2017")
    .filterBounds(point)

)


map.addLayer(border)

vec = geemap.ee_to_gdf(border)

vec

era = (
    ee.ImageCollection("ECMWF/ERA5/DAILY")
    .filterDate('2020','2021')
    .select('mean_2m_air_temperature')
)
era

import xarray as xr

ds = xr.open_dataset(
    era,
    engine = 'ee',
    crs = 'EPSG:4326',
    geometry = border.geometry(),
    scale = 0.30
)

ds = ds.sortby('time') * 1

ds.isel(time = 10).mean_2m_air_temperature.plot(
    x = 'lon', y = 'lat', robust = True
)

import geopandas as pgd

vec.plot()

!pip install rioxarray

import rioxarray

vec.crs

vec.geometry

ds_rename = ds.rename({'lon': 'x', 'lat': 'y'})

ds_clip = ds_rename.rio.clip(vec.geometry, vec.crs)

ds_clip.isel(time = 10).mean_2m_air_temperature.plot(
    x = 'x', y = 'y', robust = True
)
