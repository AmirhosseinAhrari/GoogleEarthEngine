# -*- coding: utf-8 -*-
"""GEE_0104_xarray_temp_resampling.ipynb

Tutorial Code by Amirhossein Ahrari
YouTube: https://www.youtube.com/@amirhosseinahrarigee
Tutorial Video: Google Earth Engine Tutorial-185: Temporal Aggregation in Python

This code is part of a tutorial series on Earth Engine programming techniques
presented on the Amirhossein Ahrari YouTube channel. You are free to use and modify
this code for academic and non-academic purposes. Don't forget to subscribe to
the Amirhossein Ahrari channel and follow the videos to support the instructor
"""

!pip install --upgrade xee
!pip install -U geemap

import ee

ee.Authenticate()
ee.Initialize(
    project = 'ee-amirhosseinahrari',
    opt_url = 'https://earthengine-highvolume.googleapis.com'
)

import geemap

map = geemap.Map()
map

roi = map.draw_last_feature.geometry()
roi

pr = (
    ee.ImageCollection("NOAA/PERSIANN-CDR")
    .filterDate('2015','2024')
)

pr

import xarray as xr

ds = xr.open_dataset(
    pr,
    engine = 'ee',
    crs = 'EPSG:4326',
    scale = 0.3,
    geometry = roi
)

ds = ds.sortby('time') * 1

ds

ds_monthly = ds.resample(time = 'M').sum('time')

ds_monthly.sel(time = '2020').precipitation.plot(
    x = 'lon', y = 'lat', col = 'time', robust = True, col_wrap = 6, cmap = 'turbo'
)

ds_weekly = ds.resample(time = 'W').sum('time')
ds_weekly

ds_weekly.sel(time = slice('2020-01','2020-03')).precipitation.plot(
    x = 'lon', y = 'lat', col = 'time', robust = True, col_wrap = 7, cmap = 'turbo'
)

ds_3days = ds.resample(time = '3D').sum('time')
mean_3days = ds_3days.mean(dim = ['lon','lat']).to_dataframe().precipitation

ds_monthly.mean(dim = ['lon','lat']).precipitation.plot()

mean_3days.plot()

ds_yearly = ds.resample(time = 'YE').sum('time')

ds_yearly.precipitation.plot(
    x = 'lon', y = 'lat', col = 'time', col_wrap = 3, robust = True
)

ds_month = ds_monthly.groupby('time.month').mean('time')

ds_month.precipitation.plot(
    x = 'lon', y = 'lat', col = 'month', col_wrap = 6, robust = True, cmap = 'turbo_r'
)

ds_month.mean(dim = ['lon','lat']).to_dataframe().plot()
