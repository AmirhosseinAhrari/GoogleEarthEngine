# -*- coding: utf-8 -*-
"""GEE_0091_water_deficit.ipynb

Tutorial Code by Amirhossein Ahrari
YouTube: https://www.youtube.com/@amirhosseinahrarigee
Tutorial Video: Google Earth Engine Tutorial-173: Water Deficit Index Mapping using Cartopy

This code is part of a tutorial series on Earth Engine programming techniques
presented on the Amirhossein Ahrari YouTube channel. You are free to use and modify
this code for academic and non-academic purposes. Don't forget to subscribe to
the Amirhossein Ahrari channel and follow the videos to support the instructor


"""

!pip install --upgrade xee

!pip install -U geemap

import ee

ee.Authenticate()
ee.Initialize(
    project = 'ee-amirhosseinahrari',
    opt_url = 'https://earthengine-highvolume.googleapis.com'
)

import geemap

map = geemap.Map()
map

roi = map.draw_last_feature.geometry()
roi

mod = (
    ee.ImageCollection("MODIS/061/MOD16A2GF")
    .filterDate('2001','2025')
    .select('ET','PET')
    .map(
        lambda img: img.select('PET').subtract(img.select('ET')).multiply(0.1).rename('wd')
        .copyProperties(img, ['system:time_start'])
    )
)

mod

import xarray as xr

ds = xr.open_dataset(
    mod,
    engine = 'ee',
    crs = 'EPSG:4326',
    scale = 1,
    geometry = roi
)

ds = ds.sortby('time') * 1

import numpy as np

ds_annual = ds.resample(time = 'YE').sum('time')
ds_annual_mean = ds_annual.mean(dim = 'time')
ds_annual_mean = xr.where(ds_annual_mean == 0, np.nan, ds_annual_mean)

!pip install cartopy

import matplotlib.pyplot as plt
import cartopy.crs as ccrs

plt.figure()
ax = plt.axes(projection = ccrs.Hammer())

ax.coastlines(resolution = '110m')

ds_annual_mean.wd.plot.contourf(
    x = 'lon',
    y = 'lat',
    robust = 'True',
    levels = 10,
    alpha = 0.9,
    transform = ccrs.PlateCarree(),
    cmap = 'turbo',
    cbar_kwargs = {
        'orientation': 'horizontal',
        'pad': 0.05,
        'shrink': 0.7,
        'label': 'Water Deficit Index [mm]'
    }
)

plt.savefig('wd_map.png', dpi = 360, bbox_inches = 'tight')

ds_annual_mean.wd.plot(
    x = 'lon',
    y = 'lat',
    robust = True,
    figsize = (10,5)
)

ds
